<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onevima 1.1 - Studio</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text: #f8fafc;
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            background-image: radial-gradient(circle at top right, #1e1b4b, #0f172a);
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 { margin: 0; font-weight: 600; letter-spacing: -1px; background: linear-gradient(to right, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        p { color: #94a3b8; margin-top: 5px; font-size: 0.9em; }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: 0.3s;
            cursor: pointer;
            background: rgba(255,255,255,0.02);
        }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }
        .upload-area input { display: none; }
        
        /* Video Player */
        video {
            width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
            background: #000;
        }

        /* Controls Grid */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            opacity: 0.5;
            pointer-events: none;
            transition: 0.3s;
        }
        .controls.active { opacity: 1; pointer-events: all; }

        .control-group {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
        }
        .control-group label { display: block; margin-bottom: 8px; font-size: 0.85em; color: #cbd5e1; }

        input[type="number"], select {
            width: 100%;
            background: #334155;
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-family: inherit;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* Buttons */
        .action-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .action-btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .action-btn:disabled { background: #475569; cursor: not-allowed; transform: none; }

        /* Logs & Progress */
        .log-area {
            margin-top: 20px;
            background: #0f172a;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            color: #4ade80;
            height: 100px;
            overflow-y: auto;
            display: none;
        }

        .progress-bar {
            height: 6px;
            background: #334155;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }
        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s;
        }

        /* Spinner */
        .spinner {
            width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="glass-panel">
        <header>
            <h1>Onevima 1.1</h1>
            <p>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –≤ –±—Ä–∞—É–∑–µ—Ä–µ</p>
        </header>

        <!-- –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="upload-area" id="dropZone">
            <span style="font-size: 2em;">üìÇ</span>
            <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤–∏–¥–µ–æ —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ</p>
            <input type="file" id="uploader" accept="video/*">
        </div>

        <video id="player" controls></video>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="controls" id="controlsPanel">
            <!-- –û–±—Ä–µ–∑–∫–∞ -->
            <div class="control-group">
                <label>‚úÇÔ∏è –û–±—Ä–µ–∑–∫–∞ (—Å–µ–∫)</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="start" placeholder="–°—Ç–∞—Ä—Ç" value="0">
                    <input type="number" id="end" placeholder="–ö–æ–Ω–µ—Ü">
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞—Ç –∏ –æ–ø—Ü–∏–∏ -->
            <div class="control-group">
                <label>‚öôÔ∏è –≠–∫—Å–ø–æ—Ä—Ç</label>
                <select id="format">
                    <option value="mp4">MP4 (–í–∏–¥–µ–æ)</option>
                    <option value="gif">GIF (–ê–Ω–∏–º–∞—Ü–∏—è)</option>
                    <option value="mp3">MP3 (–¢–æ–ª—å–∫–æ –∑–≤—É–∫)</option>
                </select>
                
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="mute"> <label for="mute">–ë–µ–∑ –∑–≤—É–∫–∞</label>
                </div>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="bw"> <label for="bw">–ß/–ë —Ñ–∏–ª—å—Ç—Ä</label>
                </div>
            </div>
        </div>

        <button id="processBtn" class="action-btn" disabled>
            <div class="spinner" id="spinner"></div>
            <span id="btnText">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏ –°–∫–∞—á–∞—Ç—å</span>
        </button>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="log-area" id="logs"></div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });

        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const dropZone = document.getElementById('dropZone');
        const uploader = document.getElementById('uploader');
        const player = document.getElementById('player');
        const controlsPanel = document.getElementById('controlsPanel');
        const processBtn = document.getElementById('processBtn');
        const logs = document.getElementById('logs');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');
        
        let videoFile = null;

        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const loadFFmpeg = async () => {
            log("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–≤–∏–∂–∫–∞...");
            try {
                await ffmpeg.load();
                log("–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞.");
            } catch(e) {
                log("–û—à–∏–±–∫–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ coi-serviceworker.");
            }
        };
        loadFFmpeg();

        // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ (Drag & Drop)
        dropZone.addEventListener('click', () => uploader.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        uploader.addEventListener('change', (e) => handleFile(e.target.files[0]));

        function handleFile(file) {
            if (!file || !file.type.startsWith('video/')) return;
            videoFile = file;
            player.src = URL.createObjectURL(file);
            player.style.display = 'block';
            controlsPanel.classList.add('active');
            processBtn.disabled = false;
            
            // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω—Ü–∞ –≤–∏–¥–µ–æ
            player.onloadedmetadata = () => {
                document.getElementById('end').value = Math.floor(player.duration);
            };
            
            dropZone.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –¥—Ä–æ–ø–∑–æ–Ω—É –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            log(`–ó–∞–≥—Ä—É–∂–µ–Ω: ${file.name}`);
        }

        // 3. –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        processBtn.addEventListener('click', async () => {
            if (!videoFile) return;

            // UI –±–ª–æ–∫
            processBtn.disabled = true;
            spinner.style.display = 'block';
            btnText.textContent = '–†–µ–Ω–¥–µ—Ä–∏–Ω–≥...';
            logs.style.display = 'block';
            document.getElementById('progressBar').style.display = 'block';

            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            const duration = end - start;
            const format = document.getElementById('format').value;
            const isMute = document.getElementById('mute').checked;
            const isBW = document.getElementById('bw').checked;

            const inputName = 'input_video';
            const outputName = `onevima_result.${format}`;

            ffmpeg.FS('writeFile', inputName, await fetchFile(videoFile));

            // –°–æ–±–∏—Ä–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è FFmpeg
            let args = ['-i', inputName];
            
            // –û–±—Ä–µ–∑–∫–∞
            args.push('-ss', start);
            args.push('-t', duration.toString());

            // –§–∏–ª—å—Ç—Ä—ã –≤–∏–¥–µ–æ
            let videoFilters = [];
            if (isBW) videoFilters.push('hue=s=0');
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è GIF
            if (format === 'gif') {
                // –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è GIF (–º–∞—Å—à—Ç–∞–± 320px —à–∏—Ä–∏–Ω—ã + –ø–∞–ª–∏—Ç—Ä–∞)
                videoFilters.push('fps=10,scale=320:-1:flags=lanczos');
            }

            if (videoFilters.length > 0) {
                args.push('-vf', videoFilters.join(','));
            }

            // –ê—É–¥–∏–æ
            if (isMute || format === 'gif') {
                args.push('-an'); // –£–±—Ä–∞—Ç—å –∑–≤—É–∫
            } else if (format === 'mp3') {
                args.push('-vn'); // –£–±—Ä–∞—Ç—å –≤–∏–¥–µ–æ
                args.push('-acodec', 'libmp3lame');
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç mp4 - –ø—Ä–æ–±—É–µ–º –±—ã—Å—Ç—Ä–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
                if (!isBW && !isMute) {
                     // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∏–Ω–æ–≥–¥–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å -ss –≥–ª—é—á–∏—Ç, –ø–æ—ç—Ç–æ–º—É –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ª—É—á—à–µ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å
                     // args.push('-c', 'copy'); 
                     args.push('-c:v', 'libx264', '-preset', 'ultrafast'); // –ë—ã—Å—Ç—Ä–æ–µ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
                } else {
                    args.push('-c:v', 'libx264', '-preset', 'ultrafast');
                }
            }

            args.push(outputName);

            log(`–ó–∞–ø—É—Å–∫ –∫–æ–º–∞–Ω–¥—ã: ffmpeg ${args.join(' ')}`);

            // –ò–º–∏—Ç–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ (FFmpeg WASM —Å–ª–æ–∂–Ω–æ –ø–∞—Ä—Å–∏—Ç—å —Ç–æ—á–Ω–æ)
            let progress = 0;
            const fakeProgress = setInterval(() => {
                progress += 5;
                if(progress > 90) progress = 90;
                document.getElementById('progressFill').style.width = progress + "%";
            }, 500);

            await ffmpeg.run(...args);

            clearInterval(fakeProgress);
            document.getElementById('progressFill').style.width = "100%";

            // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
            const data = ffmpeg.FS('readFile', outputName);
            const url = URL.createObjectURL(new Blob([data.buffer], { type: format === 'mp3' ? 'audio/mp3' : (format === 'gif' ? 'image/gif' : 'video/mp4') }));
            
            const a = document.createElement('a');
            a.href = url;
            a.download = outputName;
            a.click();

            // –°–±—Ä–æ—Å
            ffmpeg.FS('unlink', inputName);
            ffmpeg.FS('unlink', outputName);
            
            btnText.textContent = '–ì–æ—Ç–æ–≤–æ!';
            setTimeout(() => {
                btnText.textContent = '–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏ –°–∫–∞—á–∞—Ç—å';
                spinner.style.display = 'none';
                processBtn.disabled = false;
                document.getElementById('progressFill').style.width = "0%";
            }, 3000);
        });

        function log(msg) {
            logs.innerHTML += `> ${msg}<br>`;
            logs.scrollTop = logs.scrollHeight;
        }
    </script>
</body>
</html>
