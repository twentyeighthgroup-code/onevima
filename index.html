<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onevima 1.2 Studio</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #111827;
            --panel-bg: #1f2937;
            --accent: #8b5cf6; /* Violet */
            --accent-hover: #7c3aed;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --border: #374151;
        }

        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Header --- */
        header {
            width: 100%;
            background: var(--panel-bg);
            padding: 15px 0;
            text-align: center;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 1px; color: var(--accent); }
        h1 span { color: white; }

        /* --- Main Layout --- */
        .main-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            width: 95%;
            max-width: 1200px;
            margin-top: 30px;
            margin-bottom: 50px;
        }

        /* --- Video Section (Left) --- */
        .preview-section {
            flex: 2;
            min-width: 300px;
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
        }
        
        .upload-box {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 40px;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 20px;
        }
        .upload-box:hover { border-color: var(--accent); background: rgba(139, 92, 246, 0.1); }
        .upload-icon { font-size: 40px; margin-bottom: 10px; display: block; }
        input[type="file"] { display: none; }

        video {
            width: 100%;
            max-height: 500px;
            background: #000;
            border-radius: 8px;
            display: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* --- Tools Section (Right) --- */
        .tools-section {
            flex: 1;
            min-width: 300px;
            background: var(--panel-bg);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: fit-content;
        }
        .disabled-overlay {
            opacity: 0.5;
            pointer-events: none;
        }

        .tool-group {
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }
        .tool-group:last-child { border-bottom: none; }
        
        .tool-title {
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Inputs */
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-full { width: 100%; }
        
        label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; }
        
        input, select {
            background: #374151;
            border: 1px solid #4b5563;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            width: 100%;
        }
        input:focus, select:focus { border-color: var(--accent); }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer; background: #4b5563;
            border-radius: 2px;
        }

        /* Buttons */
        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
            font-size: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-primary:disabled { background: #4b5563; cursor: not-allowed; }

        /* Logs & Spinner */
        #logs {
            font-family: monospace;
            font-size: 12px;
            color: #10b981;
            background: #000;
            padding: 10px;
            border-radius: 6px;
            height: 100px;
            overflow-y: scroll;
            margin-top: 15px;
            display: none;
        }

        .spinner {
            width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <header>
        <h1>Onevima <span>1.2</span></h1>
    </header>

    <div class="main-container">
        
        <!-- Left: Preview -->
        <div class="preview-section">
            <div class="upload-box" id="dropArea" onclick="document.getElementById('fileInput').click()">
                <span class="upload-icon">üìÇ</span>
                <div>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –≤–∏–¥–µ–æ —Å—é–¥–∞</div>
                <div style="font-size: 0.8em; color: gray; margin-top: 5px;">MP4, MOV, MKV, AVI</div>
                <input type="file" id="fileInput" accept="video/*">
            </div>
            
            <video id="videoPlayer" controls></video>
            <div id="logs"></div>
        </div>

        <!-- Right: Tools -->
        <div class="tools-section disabled-overlay" id="toolsPanel">
            
            <!-- 1. Trimming -->
            <div class="tool-group">
                <div class="tool-title">‚úÇÔ∏è –û–±—Ä–µ–∑–∫–∞ (–¢–∞–π–º–∏–Ω–≥)</div>
                <div class="input-row">
                    <div>
                        <label>–ù–∞—á–∞–ª–æ (—Å–µ–∫)</label>
                        <input type="number" id="trimStart" value="0" step="0.1">
                    </div>
                    <div>
                        <label>–ö–æ–Ω–µ—Ü (—Å–µ–∫)</label>
                        <input type="number" id="trimEnd" value="10" step="0.1">
                    </div>
                </div>
            </div>

            <!-- 2. Format & Resolution -->
            <div class="tool-group">
                <div class="tool-title">‚öôÔ∏è –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏ –§–æ—Ä–º–∞—Ç</div>
                <div class="input-row">
                    <div class="input-full">
                        <label>–†–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞</label>
                        <select id="resolution">
                            <option value="original">–ö–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ</option>
                            <option value="scale=-2:1080">Full HD (1080p)</option>
                            <option value="scale=-2:720">HD (720p)</option>
                            <option value="scale=-2:480">SD (480p - –≠–∫–æ–Ω–æ–º)</option>
                            <option value="scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:-1:-1:color=black">TikTok / Reels (9:16)</option>
                        </select>
                    </div>
                </div>
                <div class="input-row">
                     <div class="input-full">
                        <label>–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞</label>
                        <select id="format">
                            <option value="mp4">MP4 (–°—Ç–∞–Ω–¥–∞—Ä—Ç)</option>
                            <option value="webm">WebM (–î–ª—è –≤–µ–±–∞)</option>
                            <option value="gif">GIF (–ê–Ω–∏–º–∞—Ü–∏—è)</option>
                            <option value="mp3">MP3 (–¢–æ–ª—å–∫–æ –∞—É–¥–∏–æ)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 3. Transform -->
            <div class="tool-group">
                <div class="tool-title">üîÑ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                <div class="input-row">
                    <div class="input-full">
                        <label>–ü–æ–≤–æ—Ä–æ—Ç</label>
                        <select id="rotation">
                            <option value="0">–ù–µ—Ç</option>
                            <option value="transpose=1">90¬∞ –ø–æ —á–∞—Å–æ–≤–æ–π</option>
                            <option value="transpose=2">90¬∞ –ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π</option>
                            <option value="transpose=2,transpose=2">180¬∞ (–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 4. Speed & Volume -->
            <div class="tool-group">
                <div class="tool-title">üîä –°–∫–æ—Ä–æ—Å—Ç—å –∏ –ó–≤—É–∫</div>
                <div class="input-row">
                    <div class="input-full">
                        <label>–°–∫–æ—Ä–æ—Å—Ç—å –≤–∏–¥–µ–æ: <span id="speedVal">1x</span></label>
                        <input type="range" id="speed" min="0.5" max="2.0" step="0.25" value="1">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-full">
                        <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å: <span id="volVal">100%</span></label>
                        <input type="range" id="volume" min="0" max="2.0" step="0.1" value="1">
                    </div>
                </div>
            </div>

            <!-- Action -->
            <button id="renderBtn" class="btn-primary">
                <div class="spinner" id="spinner"></div>
                <span id="btnText">–≠–∫—Å–ø–æ—Ä—Ç –≤–∏–¥–µ–æ</span>
            </button>

        </div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const videoPlayer = document.getElementById('videoPlayer');
        const toolsPanel = document.getElementById('toolsPanel');
        const dropArea = document.getElementById('dropArea');
        const renderBtn = document.getElementById('renderBtn');
        const logs = document.getElementById('logs');
        
        // Inputs
        const trimStart = document.getElementById('trimStart');
        const trimEnd = document.getElementById('trimEnd');
        const resolution = document.getElementById('resolution');
        const formatSelect = document.getElementById('format');
        const rotation = document.getElementById('rotation');
        const speed = document.getElementById('speed');
        const volume = document.getElementById('volume');

        // Labels
        const speedVal = document.getElementById('speedVal');
        const volVal = document.getElementById('volVal');

        let loadedFile = null;

        // --- Init FFmpeg ---
        const init = async () => {
            if(!ffmpeg.isLoaded()) await ffmpeg.load();
            console.log("Onevima Engine Loaded");
        };
        init();

        // --- Event Listeners ---
        speed.addEventListener('input', (e) => speedVal.innerText = e.target.value + 'x');
        volume.addEventListener('input', (e) => volVal.innerText = Math.round(e.target.value * 100) + '%');

        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.borderColor = '#8b5cf6'; });
        dropArea.addEventListener('dragleave', (e) => { dropArea.style.borderColor = '#374151'; });
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#374151';
            handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            if (!file || !file.type.startsWith('video/')) return;
            loadedFile = file;
            videoPlayer.src = URL.createObjectURL(file);
            videoPlayer.style.display = 'block';
            dropArea.style.display = 'none';
            toolsPanel.classList.remove('disabled-overlay');
            logs.style.display = 'block';
            log(`–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`);

            videoPlayer.onloadedmetadata = () => {
                trimEnd.value = videoPlayer.duration;
            };
        }

        // --- Core Logic ---
        renderBtn.addEventListener('click', async () => {
            if (!loadedFile) return;
            
            setLoading(true);

            const ext = formatSelect.value;
            const inputName = 'input_video';
            const outputName = `onevima_export.${ext}`;

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ –ø–∞–º—è—Ç—å
            ffmpeg.FS('writeFile', inputName, await fetchFile(loadedFile));

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            let videoFilters = [];
            let audioFilters = [];

            // 1. Resolution / Crop
            if (resolution.value !== 'original') videoFilters.push(resolution.value);

            // 2. Rotation
            if (rotation.value !== '0') videoFilters.push(rotation.value);

            // 3. Speed (Video PTS)
            const speedValue = parseFloat(speed.value);
            if (speedValue !== 1) {
                // setpts = 1/speed * PTS
                videoFilters.push(`setpts=${1/speedValue}*PTS`);
                audioFilters.push(`atempo=${speedValue}`); // –ê—É–¥–∏–æ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å
            }

            // 4. Volume
            const volValue = parseFloat(volume.value);
            if (volValue !== 1) audioFilters.push(`volume=${volValue}`);

            // –°–±–æ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥—ã
            let args = ['-i', inputName];

            // –û–±—Ä–µ–∑–∫–∞ (–±—ã—Å—Ç—Ä–∞—è, –¥–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤)
            args.push('-ss', trimStart.value);
            args.push('-t', (trimEnd.value - trimStart.value).toString());

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            if (ext === 'mp3') {
                // –¢–æ–ª—å–∫–æ –∞—É–¥–∏–æ
                if (audioFilters.length > 0) args.push('-af', audioFilters.join(','));
                args.push('-vn'); // –ë–µ–∑ –≤–∏–¥–µ–æ
            } else if (ext === 'gif') {
                // GIF Specific
                videoFilters.push('fps=10,scale=320:-1:flags=lanczos');
                args.push('-vf', videoFilters.join(','));
            } else {
                // –í–∏–¥–µ–æ (MP4/WebM)
                if (videoFilters.length > 0) args.push('-vf', videoFilters.join(','));
                if (audioFilters.length > 0) args.push('-af', audioFilters.join(','));
                
                // –ö–æ–¥–µ–∫–∏
                args.push('-c:v', ext === 'webm' ? 'libvpx-vp9' : 'libx264');
                if (ext !== 'webm') args.push('-preset', 'ultrafast'); // –°–∫–æ—Ä–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ —Å–∂–∞—Ç–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
            }

            args.push(outputName);

            log("–ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∂–¥–∏—Ç–µ.");
            log(`–ö–æ–º–∞–Ω–¥–∞: ffmpeg ${args.join(' ')}`);

            try {
                await ffmpeg.run(...args);
                
                // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
                const data = ffmpeg.FS('readFile', outputName);
                const url = URL.createObjectURL(new Blob([data.buffer], { type: `video/${ext}` }));
                
                const a = document.createElement('a');
                a.href = url;
                a.download = outputName;
                a.click();
                
                log("–ì–æ—Ç–æ–≤–æ! –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å.");
            } catch (error) {
                log("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ø—Ä–æ—â–µ.");
                console.error(error);
            }

            // –û—á–∏—Å—Ç–∫–∞
            ffmpeg.FS('unlink', inputName);
            try { ffmpeg.FS('unlink', outputName); } catch(e){}
            
            setLoading(false);
        });

        function setLoading(active) {
            renderBtn.disabled = active;
            document.getElementById('spinner').style.display = active ? 'block' : 'none';
            document.getElementById('btnText').innerText = active ? '–û–±—Ä–∞–±–æ—Ç–∫–∞...' : '–≠–∫—Å–ø–æ—Ä—Ç –≤–∏–¥–µ–æ';
        }

        function log(msg) {
            logs.innerHTML += `> ${msg}<br>`;
            logs.scrollTop = logs.scrollHeight;
        }
    </script>
</body>
</html>
