<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onevima 1.3 - Live Studio</title>
    
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <!-- –ò–∫–æ–Ω–∫–∏ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- –°–ª–∞–π–¥–µ—Ä -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

    <style>
        :root { --bg: #000000; --panel: #1c1c1e; --accent: #0A84FF; --text: #ffffff; }
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* --- LAYOUT --- */
        .app-container { display: flex; width: 100%; height: 100%; }

        /* Left: Tools */
        .sidebar { width: 320px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; z-index: 10; }
        
        .header { padding: 20px; border-bottom: 1px solid #333; font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; }
        .header span { color: var(--accent); }

        .tools-scroll { flex: 1; overflow-y: auto; padding: 20px; }

        .tool-section { margin-bottom: 30px; }
        .tool-title { font-size: 0.8rem; text-transform: uppercase; color: #888; margin-bottom: 10px; font-weight: 600; letter-spacing: 1px; }

        /* Buttons Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

        .btn-option {
            background: #2c2c2e; border: 1px solid transparent; border-radius: 8px; padding: 15px 10px;
            text-align: center; cursor: pointer; transition: 0.2s; font-size: 0.85rem; color: #ccc;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .btn-option i { font-size: 1.2rem; margin-bottom: 2px; }
        .btn-option:hover { background: #3a3a3c; }
        .btn-option.active { background: rgba(10, 132, 255, 0.2); border-color: var(--accent); color: white; }

        /* Inputs */
        input[type="text"] { width: 100%; background: #2c2c2e; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        
        /* Render Button */
        .footer-action { padding: 20px; border-top: 1px solid #333; }
        .btn-main { width: 100%; background: var(--accent); color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .btn-main:hover { opacity: 0.9; }
        .btn-main:disabled { background: #333; color: #555; cursor: not-allowed; }

        /* Center: Stage */
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; background: #000; }
        
        /* THE PREVIEW BOX */
        .preview-wrapper { 
            position: relative; 
            max-width: 90%; 
            max-height: 70vh;
            border-radius: 12px;
            overflow: hidden; /* –û–±—Ä–µ–∑–∞–µ—Ç –≤—Å–µ, —á—Ç–æ –≤—ã–ª–∞–∑–∏—Ç */
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }

        video { display: block; width: 100%; height: 100%; object-fit: contain; }

        /* OVERLAY LAYER (–ú–∞–≥–∏—è CSS) */
        .overlay-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* –ß—Ç–æ–±—ã –∫–ª–∏–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Å–∫–≤–æ–∑—å —Ç–µ–∫—Å—Ç –∫ –≤–∏–¥–µ–æ */
            display: flex; justify-content: center; align-items: center;
        }

        #liveText {
            font-family: 'Roboto', sans-serif;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            white-space: pre-wrap;
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }

        /* Timeline Area */
        .timeline-area { width: 80%; margin-top: 20px; padding: 0 20px; }
        .noUi-connect { background: var(--accent); }
        .noUi-handle { background: white; border-radius: 50%; width: 16px; height: 16px; right: -8px; border: none; box-shadow: none; cursor: grab; }

        /* Upload State */
        .empty-state { text-align: center; color: #555; cursor: pointer; }
        .empty-state i { font-size: 4rem; margin-bottom: 15px; color: #333; transition: 0.3s; }
        .empty-state:hover i { color: var(--accent); }

        /* Loader */
        .loader-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="header">Onevima <span>7.0</span></div>
            
            <div class="tools-scroll">
                
                <!-- Section 1: Aspect Ratio -->
                <div class="tool-section">
                    <div class="tool-title">–§–æ—Ä–º–∞—Ç</div>
                    <div class="grid-3">
                        <div class="btn-option active" onclick="setAspect('orig', this)"><i class="fas fa-expand"></i>–û—Ä–∏–≥.</div>
                        <div class="btn-option" onclick="setAspect('9:16', this)"><i class="fas fa-mobile-alt"></i>TikTok</div>
                        <div class="btn-option" onclick="setAspect('1:1', this)"><i class="fas fa-square"></i>Insta</div>
                    </div>
                </div>

                <!-- Section 2: Look -->
                <div class="tool-section">
                    <div class="tool-title">–°—Ç–∏–ª—å (–§–∏–ª—å—Ç—Ä—ã)</div>
                    <div class="grid-2">
                        <div class="btn-option active" onclick="setFilter('none', this)">–û–±—ã—á–Ω—ã–π</div>
                        <div class="btn-option" onclick="setFilter('bw', this)">üé¨ –ß/–ë</div>
                        <div class="btn-option" onclick="setFilter('contrast', this)">üî• –°–æ—á–Ω–æ</div>
                        <div class="btn-option" onclick="setFilter('warm', this)">‚òÄÔ∏è –¢–µ–ø–ª–æ</div>
                    </div>
                </div>

                <!-- Section 3: Text -->
                <div class="tool-section">
                    <div class="tool-title">–¢–µ–∫—Å—Ç –Ω–∞ –≤–∏–¥–µ–æ</div>
                    <input type="text" id="TextInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å..." oninput="updateText()">
                    
                    <div class="grid-3" style="margin-bottom: 10px;">
                        <div class="btn-option" onclick="setFont('Impact', this)">Bold</div>
                        <div class="btn-option" onclick="setFont('Roboto', this)">Sans</div>
                        <div class="btn-option" onclick="setFont('Pacifico', this)">Art</div>
                    </div>
                    
                    <div class="grid-3">
                        <div class="btn-option active" onclick="setColor('white', this)">‚ö™</div>
                        <div class="btn-option" onclick="setColor('#Facc15', this)">üü°</div>
                        <div class="btn-option" onclick="setColor('#f87171', this)">üî¥</div>
                    </div>
                </div>

            </div>

            <div class="footer-action">
                <button class="btn-main" id="renderBtn" onclick="render()" disabled>–°–∫–∞—á–∞—Ç—å –í–∏–¥–µ–æ</button>
            </div>
        </div>

        <!-- STAGE -->
        <div class="stage">
            
            <!-- Upload Box (Hidden after upload) -->
            <div class="empty-state" id="uploadBox" onclick="document.getElementById('fileIn').click()">
                <i class="fas fa-cloud-upload-alt"></i>
                <h2>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ</h2>
                <p>MP4, MOV</p>
            </div>
            <input type="file" id="fileIn" accept="video/*" hidden>

            <!-- Preview Wrapper (Video + Overlay) -->
            <div class="preview-wrapper" id="previewBox" style="display:none;">
                <video id="vidEl" controls></video>
                <div class="overlay-layer">
                    <div id="liveText"></div>
                </div>
            </div>

            <!-- Timeline -->
            <div class="timeline-area" id="timeBox" style="display:none;">
                <div id="slider"></div>
                <div style="text-align: center; color: #555; font-size: 0.8rem; margin-top: 10px;">–î–≤–∏–≥–∞–π—Ç–µ –ø–æ–ª–∑—É–Ω–∫–∏ –¥–ª—è –æ–±—Ä–µ–∑–∫–∏</div>
            </div>

            <!-- Loader -->
            <div class="loader-overlay" id="loader">
                <div class="spinner"></div>
                <div id="statusText">–û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
                <div style="color:#555; font-size:0.8rem; margin-top:10px">–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –≤–∫–ª–∞–¥–∫—É</div>
            </div>

        </div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });

        // State
        let state = {
            file: null,
            filter: 'none',
            aspect: 'orig',
            text: '',
            font: 'Impact',
            color: 'white',
            trim: { s: 0, e: 0 }
        };

        const fontUrls = {
            'Impact': 'https://cdn.jsdelivr.net/gh/google/fonts/ofl/anton/Anton-Regular.ttf', // Anton as Impact alternative
            'Roboto': 'https://cdn.jsdelivr.net/gh/google/fonts/apache/roboto/Roboto-Regular.ttf',
            'Pacifico': 'https://cdn.jsdelivr.net/gh/google/fonts/ofl/pacifico/Pacifico-Regular.ttf'
        };

        // UI References
        const vidEl = document.getElementById('vidEl');
        const liveText = document.getElementById('liveText');
        const uploadBox = document.getElementById('uploadBox');
        const previewBox = document.getElementById('previewBox');
        const timeBox = document.getElementById('timeBox');
        const renderBtn = document.getElementById('renderBtn');
        const slider = document.getElementById('slider');

        // --- INIT SLIDER ---
        noUiSlider.create(slider, { start: [0, 100], connect: true, range: { min: 0, max: 100 } });

        // --- UPLOAD HANDLER ---
        document.getElementById('fileIn').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            state.file = file;
            
            const url = URL.createObjectURL(file);
            vidEl.src = url;
            
            uploadBox.style.display = 'none';
            previewBox.style.display = 'block';
            
            vidEl.onloadedmetadata = () => {
                timeBox.style.display = 'block';
                slider.noUiSlider.updateOptions({ range: { min: 0, max: vidEl.duration }, start: [0, vidEl.duration] });
                renderBtn.disabled = false;
            };
        });

        // --- LIVE PREVIEW LOGIC (CSS MAGIC) ---
        
        function setFilter(val, el) {
            state.filter = val;
            
            // Visual feedback on buttons
            document.querySelectorAll(`[onclick^="setFilter"]`).forEach(b => b.classList.remove('active'));
            if(el) el.classList.add('active');

            // Apply CSS Filter to Video Tag
            vidEl.style.filter = 'none';
            if(val === 'bw') vidEl.style.filter = 'grayscale(1)';
            if(val === 'contrast') vidEl.style.filter = 'contrast(1.3) saturate(1.3)';
            if(val === 'warm') vidEl.style.filter = 'sepia(0.4)';
        }

        function setAspect(val, el) {
            state.aspect = val;
            document.querySelectorAll(`[onclick^="setAspect"]`).forEach(b => b.classList.remove('active'));
            if(el) el.classList.add('active');

            // Simulate Aspect Ratio in Preview
            // Note: We can't easily crop the video tag visually without complex divs, 
            // so we rely on FFmpeg for the final cut, but we could add black bars in CSS if needed.
            // For convenience, we assume user trusts the button.
        }

        function updateText() {
            const val = document.getElementById('TextInput').value;
            state.text = val;
            
            if(val.trim() === '') {
                liveText.style.display = 'none';
            } else {
                liveText.style.display = 'block';
                liveText.innerText = val;
            }
        }

        function setFont(val, el) {
            state.font = val;
            document.querySelectorAll(`[onclick^="setFont"]`).forEach(b => b.classList.remove('active'));
            if(el) el.classList.add('active');
            
            // Apply CSS Font
            if(val === 'Impact') liveText.style.fontFamily = 'Impact, sans-serif';
            if(val === 'Pacifico') liveText.style.fontFamily = 'cursive';
            if(val === 'Roboto') liveText.style.fontFamily = 'sans-serif';
        }

        function setColor(val, el) {
            state.color = val;
            document.querySelectorAll(`[onclick^="setColor"]`).forEach(b => b.classList.remove('active'));
            if(el) el.classList.add('active');
            
            liveText.style.color = val;
        }

        // Slider Updates
        slider.noUiSlider.on('update', (v) => {
            state.trim.s = parseFloat(v[0]);
            state.trim.e = parseFloat(v[1]);
        });

        // --- RENDER LOGIC (FFMPEG) ---
        async function render() {
            const loader = document.getElementById('loader');
            const status = document.getElementById('statusText');
            loader.style.display = 'flex';
            
            status.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–≤–∏–∂–∫–∞...";
            if(!ffmpeg.isLoaded()) await ffmpeg.load();

            status.innerText = "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤–∏–¥–µ–æ...";
            ffmpeg.FS('writeFile', 'in.mp4', await fetchFile(state.file));

            // Font loading
            if(state.text) {
                status.innerText = "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞...";
                const fontData = await fetch(fontUrls[state.font]).then(r => r.arrayBuffer());
                ffmpeg.FS('writeFile', 'font.ttf', new Uint8Array(fontData));
            }

            // Build Filters
            let filters = [];
            
            // 1. Trim
            filters.push(`trim=${state.trim.s}:${state.trim.e},setpts=PTS-STARTPTS`);

            // 2. Aspect Ratio (FFmpeg logic)
            if(state.aspect === '9:16') filters.push('scale=1080:1920:force_original_aspect_ratio=decrease,pad=1080:1920:(ow-iw)/2:(oh-ih)/2:black');
            if(state.aspect === '1:1') filters.push('scale=1080:1080:force_original_aspect_ratio=decrease,pad=1080:1080:(ow-iw)/2:(oh-ih)/2:black');

            // 3. Look (Matching CSS logic)
            if(state.filter === 'bw') filters.push('hue=s=0');
            if(state.filter === 'contrast') filters.push('eq=contrast=1.3:saturation=1.3');
            if(state.filter === 'warm') filters.push('colorchannelmixer=.393:.769:.189:0:.349:.686:.168:0:.272:.534:.131');

            // 4. Text
            if(state.text) {
                const safeText = state.text.replace(/:/g, "\\:");
                // Center positioning logic
                filters.push(`drawtext=fontfile=font.ttf:text='${safeText}':fontcolor=${state.color}:fontsize=60:x=(w-text_w)/2:y=(h-text_h)/2`);
            }

            status.innerText = "–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ (–ñ–¥–∏—Ç–µ)...";

            // Command Construction
            let cmd = ['-i', 'in.mp4'];
            // Sync Audio Trim
            let complex = `[0:v]${filters.join(',')}[v];[0:a]atrim=${state.trim.s}:${state.trim.e},asetpts=PTS-STARTPTS[a]`;
            
            cmd.push('-filter_complex', complex, '-map', '[v]', '-map', '[a]');
            cmd.push('-c:v', 'libx264', '-preset', 'ultrafast', 'out.mp4');

            try {
                await ffmpeg.run(...cmd);
                
                const data = ffmpeg.FS('readFile', 'out.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'onevima_edit.mp4';
                a.click();
                
                status.innerText = "–ì–æ—Ç–æ–≤–æ!";
                setTimeout(() => loader.style.display = 'none', 2000);
            } catch(e) {
                status.innerText = "–û—à–∏–±–∫–∞!";
                console.error(e);
                alert("–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
                loader.style.display = 'none';
            }

            // Cleanup
            try {
                ffmpeg.FS('unlink', 'in.mp4');
                ffmpeg.FS('unlink', 'out.mp4');
                if(state.text) ffmpeg.FS('unlink', 'font.ttf');
            } catch(e){}
        }

    </script>
</body>
</html>
